@echo off
chcp 65001 >nul 2>&1
title ClaudeCode_Remote - First Install

echo.
echo ============================================================
echo   ClaudeCode_Remote - First Time Setup
echo ============================================================
echo.

REM Get current username
set "USERNAME=%USERNAME%"

echo [1/5] Checking Node.js...
where node >nul 2>nul
if %ERRORLEVEL% NEQ 0 (
    echo [ERROR] Node.js is not installed!
    echo.
    echo Please install Node.js from: https://nodejs.org/
    echo Then run this script again.
    echo.
    pause
    exit /b 1
)
for /f "tokens=*" %%i in ('node --version') do set NODE_VERSION=%%i
echo [OK] Node.js %NODE_VERSION% found
echo.

echo [2/5] Checking cloudflared...
where cloudflared >nul 2>nul
if %ERRORLEVEL% NEQ 0 (
    echo [!] cloudflared not found. Installing via winget...
    echo.
    winget install Cloudflare.cloudflared -e --silent
    if %ERRORLEVEL% NEQ 0 (
        echo [ERROR] Failed to install cloudflared automatically.
        echo.
        echo Please install manually:
        echo   winget install Cloudflare.cloudflared
        echo.
        echo Or download from: https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/install-and-setup/installation/
        echo.
        pause
        exit /b 1
    )
    echo [OK] cloudflared installed successfully
) else (
    echo [OK] cloudflared already installed
)
echo.

echo [3/5] Installing npm dependencies...
call npm install
if %ERRORLEVEL% NEQ 0 (
    echo [ERROR] npm install failed!
    pause
    exit /b 1
)
echo [OK] Dependencies installed
echo.

echo [4/5] Creating .env configuration file...
if exist .env (
    echo [!] .env already exists, skipping...
    echo     Delete .env and run again to reconfigure.
) else (
    (
        echo # ClaudeCode_Remote Configuration
        echo # Generated by first-install.bat
        echo.
        echo # Server port
        echo PORT=3000
        echo.
        echo # Path to Claude Code data directory
        echo CLAUDE_DIR=C:\Users\%USERNAME%\.claude
        echo.
        echo # Authentication token ^(leave empty to disable^)
        echo AUTH_TOKEN=
        echo.
        echo # Anthropic API Key for usage tracking ^(optional^)
        echo # Get your key at: https://console.anthropic.com/settings/keys
        echo ANTHROPIC_API_KEY=
        echo.
        echo # Debug mode
        echo DEBUG=false
    ) > .env
    echo [OK] .env created with CLAUDE_DIR=C:\Users\%USERNAME%\.claude
)
echo.

echo [5/5] Installing permission hooks...
call node scripts/install-hooks.js
if %ERRORLEVEL% NEQ 0 (
    echo [!] Hook installation had issues (non-critical)
    echo     You can run 'node scripts/install-hooks.js' later
) else (
    echo [OK] Hooks installed
)
echo.

echo ============================================================
echo   SETUP COMPLETE!
echo ============================================================
echo.
echo Your configuration:
echo   - CLAUDE_DIR: C:\Users\%USERNAME%\.claude
echo   - Server port: 3000
echo.
echo Next steps:
echo   1. (Optional) Edit .env to add your ANTHROPIC_API_KEY
echo   2. Run launch.bat to start the application
echo.
echo ============================================================
echo.
pause
